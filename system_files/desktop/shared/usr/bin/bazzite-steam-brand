#!/usr/bin/bash
# use our branding for steam

if [ ! -d $HOME/.local/share/Steam ]; then
# Set up steam with the bootstrap before starting it, this allows steam to run for the first time even with no network access
if [[ -f "/usr/share/gamescope-session-plus/bootstrap_steam.tar.gz" ]]; then
    mkdir -p ~/.local/share
    tar xf /usr/share/gamescope-session-plus/bootstrap_steam.tar.gz -C ~/.local/share
fi
fi

DECK_STARTUP="/usr/share/ublue-os/bazzite/bazzite.webm"
DECK_SUSPEND="/usr/share/ublue-os/bazzite/bazzite-suspend.webm"
OLED_STARTUP="/usr/share/ublue-os/bazzite/bazzite-oled.webm"
OLED_SUSPEND="/usr/share/ublue-os/bazzite/bazzite-suspend-oled.webm"
SKIP_VIDEOS=false

# Check for Galileo model
if [[ ":Galileo:" =~ ":$SYS_ID:" ]]; then
VIDEO_STARTUP=$OLED_STARTUP
VIDEO_SUSPEND=$OLED_SUSPEND
else
VIDEO_STARTUP=$DECK_STARTUP
VIDEO_SUSPEND=$DECK_SUSPEND
fi

# Install Bazzite's Steam Game Mode Startup & Suspend Videos
mkdir -p $HOME/.local/share/Steam/config/uioverrides/movies

# Check for the no video flag
if [ -f $HOME/.local/share/Steam/config/uioverrides/movies/bazzite_novideo ]; then
SKIP_VIDEOS=true
fi

# Check for the Animation Changer plugin, if it exists then they probably don't want us.
if [ -f $HOME/homebrew/plugins/SDH-AnimationChanger/main.py ]; then
SKIP_VIDEOS=true
fi

if ! $SKIP_VIDEOS; then
    LOCATION_STARTUP=$HOME/.local/share/Steam/config/uioverrides/movies/deck_startup.webm
    LOCATION_SUSPEND=$HOME/.local/share/Steam/config/uioverrides/movies/steam_os_suspend.webm
    LOCATION_SUSPEND_OLD=$HOME/.local/share/Steam/config/uioverrides/movies/deck-suspend-animation.webm
    LOCATION_THROBBER=$HOME/.local/share/Steam/config/uioverrides/movies/steam_os_suspend_from_throbber.webm
    LOCATION_THROBBER_OLD=$HOME/.local/share/Steam/config/uioverrides/movies/deck-suspend-animation-from-throbber.webm

    if ! cmp --silent $VIDEO_STARTUP $LOCATION_STARTUP; then
        cp $VIDEO_STARTUP $LOCATION_STARTUP
    fi

    if ! cmp --silent $VIDEO_SUSPEND $LOCATION_SUSPEND; then
        cp $VIDEO_SUSPEND $LOCATION_SUSPEND
    fi

    if ! cmp --silent $VIDEO_SUSPEND $LOCATION_SUSPEND_OLD; then
        cp $VIDEO_SUSPEND $LOCATION_SUSPEND_OLD
    fi

    if ! cmp --silent $VIDEO_SUSPEND $LOCATION_THROBBER; then
        cp $VIDEO_SUSPEND $LOCATION_THROBBER
    fi

    if ! cmp --silent $VIDEO_SUSPEND $LOCATION_THROBBER_OLD; then
        cp $VIDEO_SUSPEND $LOCATION_THROBBER_OLD
    fi
fi